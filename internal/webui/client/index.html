<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebRTC Troubleshooting</title>
</head>
<body>
<span>Hello!</span>
<div class="controls">
    <button id="controls__start">Start</button>
</div>
<div class="state">
    <h2>ICE</h2>
    <div id="iceConnectionStates"></div>
</div>
<div class="messaging">
    <h2>Data messages</h2>
    <div id="inboundDataChannelMessages"></div>
</div>
</body>
<script>
    const socket = (() => {
        const handlers = {};
        let _socket;
        const connect = () => {
            _socket = new WebSocket(`ws://${window.location.host}/websocket`)
            _socket.onmessage = e => {
                const msg = JSON.parse(e.data)
                if (!msg) {
                    return console.log('failed to parse msg')
                }
                Object.getOwnPropertyNames(handlers).forEach(function (val) {
                    handlers[val](msg)
                });
            }
            _socket.onopen = () => {
                console.log('socket opened')
            }
        }
        const addHandler = (id, handler) => handlers[id] = handler

        const send = (data) => _socket.send(data)

        return {
            addHandler,
            connect,
            send,
        }
    })();

    const webrtc = (() => {
        const connect = (signal) => {
            const pc = new RTCPeerConnection({iceServers: [{urls: 'stun:stun.l.google.com:19302'}]})

            pc.oniceconnectionstatechange = () => {
                let el = document.createElement('p')
                el.appendChild(document.createTextNode(pc.iceConnectionState))
                document.getElementById('iceConnectionStates').appendChild(el);
            }

            let dc = pc.createDataChannel('data')
            dc.onmessage = event => {
                let el = document.createElement('p')
                el.appendChild(document.createTextNode(event.data))
                document.getElementById('inboundDataChannelMessages').appendChild(el);
            }

            pc.onicecandidate = e => {
                if (!(e.candidate && e.candidate.candidate !== "")) return
                signal.send(e.candidate)
            }

            signal.onMessage((message) => {
                if (message.candidate) {
                    pc.addIceCandidate(message)
                } else {
                    pc.setRemoteDescription(message)
                }
            })

            pc.createOffer().then(offer => {
                pc.setLocalDescription(offer)
                signal.send(offer);
            })
        }
        return {
            connect,
        }
    })();

    const signal = (() => {
        let messageHandler = () => ({})

        socket.addHandler('signal', (m) => messageHandler(m))

        return {
            onMessage: (handler) => messageHandler = handler,
            send: (data) => socket.send(JSON.stringify(data))
        }
    })(socket);

    (() => {
        socket.connect()

        const startEl = document.getElementById('controls__start');
        startEl.addEventListener('click', () => {
            webrtc.connect(signal);
        })
    })()
</script>
</html>
