<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebRTC Troubleshooting</title>
</head>
<body>
<span>Hello!</span>
<div class="controls">
    <button id="controls__start">Start</button>
    <button id="controls__stop">Stop</button>
</div>
<div class="state">
    <h2>ICE</h2>
    <div id="iceConnectionStates"></div>
</div>
<div class="messaging">
    <h2>Data messages</h2>
    <div id="inboundDataChannelMessages"></div>
</div>
</body>
<script>
    const socket = (() => {
        const handlers = {};
        let _socket;
        const connect = () => new Promise(function (resolve, reject) {
            _socket = new WebSocket(`ws://${window.location.host}/websocket`)
            _socket.onmessage = e => {
                const msg = JSON.parse(e.data)
                if (!msg) {
                    return console.log('failed to parse msg')
                }
                Object.getOwnPropertyNames(handlers).forEach(function (val) {
                    handlers[val](msg)
                });
            }
            _socket.onopen = (e) => {
                console.log('socket opened')
                resolve(e)
            }
            _socket.onerror = (e) => {
                reject(e)
            }
        })
        const handler = (id, handler) => handlers[id] = handler

        const send = (data) => _socket.send(data)

        const disconnect = () => _socket.close()

        return {
            connect,
            disconnect,
            send,
            handler,
        }
    })();

    const webrtc = (() => {
        let pc
        let _signal

        const connect = async (signal) => {
            await signal.connect()
            // !to add error handler
            _signal = signal
            pc = new RTCPeerConnection({iceServers: [{urls: 'stun:stun.l.google.com:19302'}]})

            pc.oniceconnectionstatechange = () => {
                let el = document.createElement('p')
                el.appendChild(document.createTextNode(pc.iceConnectionState))
                document.getElementById('iceConnectionStates').appendChild(el);
            }

            let dc = pc.createDataChannel('data')
            dc.onmessage = event => {
                let el = document.createElement('p')
                el.appendChild(document.createTextNode(event.data))
                document.getElementById('inboundDataChannelMessages').appendChild(el);
            }

            pc.onicecandidate = e => {
                if (!(e.candidate && e.candidate.candidate !== "")) return
                signal.send(e.candidate)
            }

            signal.wire((message) => {
                if (message.candidate) {
                    pc.addIceCandidate(message)
                } else {
                    pc.setRemoteDescription(message)
                }
            })

            pc.createOffer().then(offer => {
                pc.setLocalDescription(offer)
                signal.send(offer);
            })
        }
        const disconnect = () => {
            if (!pc) return

            pc.close()
            _signal.disconnect()
        }
        return {
            connect,
            disconnect,
        }
    })();


    const signal = (() => {
        const SIGNAL = 'x'
        return ({transport = {send: () => ({}), handler: () => ({})}}) => ({
            wire: (handler) => {
                transport.handler(SIGNAL, handler)
            },
            send: (dat) => transport.send(JSON.stringify(dat)),
            connect: async () => transport.connect(),
            disconnect: () => transport.disconnect()
        })
    })();

    (() => {
        const startEl = document.getElementById('controls__start');
        const stopEl = document.getElementById('controls__stop');
        startEl.addEventListener('click', () => {
            webrtc.connect(signal({transport: socket}));
        })
        stopEl.addEventListener('click', () => {
            webrtc.disconnect()
        })
    })()
</script>
</html>
