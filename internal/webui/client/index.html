<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebRTC Testing & Troubleshooting Tool</title>
    <style>
        .container {
            display: flex;
            flex-direction: column;

            margin-left: auto;
            margin-right: auto;
            max-width: 64rem;
        }

        .container__main {
            flex-grow: 1;

            display: flex;
            flex-direction: row;
        }

        .container__left {
            width: 25%;
        }

        .container__middle {
            flex-grow: 1;
            display: flex;
            align-items: end;
            justify-content: center;
        }

        .container__right {
            width: 20%;
        }

        .cards {
            display: flex;

            flex-wrap: wrap;

            margin-left: -8px;
            margin-right: -8px;
        }

        .cards__item {
            flex-basis: 25%;

            padding-left: 8px;
            padding-right: 8px;
        }

        .log {
            align-items: center;
            display: grid;
            grid-template-columns: 15px 1fr 28fr;
        }

        .log div {
            font-size: smaller;
        }

        .log__status, .log__tag {
            align-self: normal;
        }

        .log__status {
            background-color: rgb(66, 153, 225);

            border-radius: 9999px;

            height: 8px;
            width: 8px;
        }

        .log__tag {
            color: rgba(0, 0, 0, .45);
            text-transform: uppercase;
        }

        .log__client {
            background-color: #e18a42;
        }

        .log__content {
            flex: 1;
        }

        .options {
            align-items: center;
            display: flex;

            justify-content: space-between;
            border-bottom: 1px solid rgba(0, 0, 0, 0.3);

            margin: 0;
            padding: 8px 0;
        }

        .options dd {
            margin: 0;
        }

        div#inboundDataChannelMessages, div#iceConnectionStates {
            height: 100px;
            overflow: auto;
            font-size: 80%;
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        WebRTC Testing & Troubleshooting Tool
    </header>
    <main class="container__main">
        <div class="container__left">...</div>

        <div class="container__middle">

            <!--            <div class="cards">-->
            <!--                <div class="cards__item">-->
            <!--                    <div class="state">-->
            <!--                        <h3>ICE</h3>-->
            <!--                        <div id="iceConnectionStates"></div>-->
            <!--                    </div>-->
            <!--                </div>-->

            <!--                <div class="cards__item">-->
            <!--                    <div class="messaging">-->
            <!--                        <h3>Data channel</h3>-->
            <!--                        <div id="inboundDataChannelMessages"></div>-->
            <!--                    </div>-->
            <!--                </div>-->
            <!--                <div class="cards__item">-->
            <!--                    <h3>Audio channel</h3>-->
            <!--                </div>-->
            <!--                <div class="cards__item">-->
            <!--                    <h3>Video channel</h3>-->
            <!--                </div>-->
            <!--            </div>-->
            <div class="controls">
                <button id="controls__start">Start</button>
                <button id="controls__stop">Stop</button>
            </div>

        </div>

        <div class="container__right">
            <h4>Options </h4>
            <dl class="options">
                <dt>Disable default Interceptors</dt>
                <dd><input type="checkbox"/></dd>
            </dl>
            <dl class="options">
                <dt>Set DTLS role</dt>
                <dd><input type="text"/></dd>
            </dl>
            <dl class="options">
                <dt>Use ICE Lite</dt>
                <dd><input type="checkbox"/></dd>
            </dl>
            <dl class="options">
                <dt>Set a single port</dt>
                <dd><input type="text"/></dd>
            </dl>
            <dl class="options">
                <dt>Set NAT-IP-MAP</dt>
                <dd><input type="text"/></dd>
            </dl>
        </div>
    </main>
    <footer>
        <div class="logging">
            <h3>Log</h3>
            <div id="logMessages"></div>
        </div>
    </footer>
</div>
</body>
<script>
    const gui = (() => {
        const dest = document.getElementById('logMessages')

        const log = (message, server = true, tag) => {
            const el = document.createElement('div')
            if (message) {
                el.classList.add("log")
                el.innerHTML = `
                        <div class="log__status${server ? ' log__server' : ' log__client'}"></div>
                        ${tag ? `<div class="log__tag">${tag}</div>` : ''}
                        <div class="log__content">${message}</div>
                        `
            } else {
                el.innerText = `-----------------------------------------------------------`
            }
            dest.appendChild(el)
        }

        return {
            log,
        }
    })()

    const socket = (() => {
        const handlers = {};
        let _socket;
        const connect = () => new Promise(function (resolve, reject) {
            _socket = new WebSocket(`ws://${window.location.host}/websocket`)
            _socket.onmessage = e => {
                const msg = JSON.parse(e.data)
                if (!msg) {
                    return console.log('failed to parse msg')
                }
                Object.getOwnPropertyNames(handlers).forEach(function (val) {
                    handlers[val](msg)
                });
            }
            _socket.onopen = (e) => {
                gui.log('socket opened', false, 'WS')
                resolve(e)
            }
            _socket.onerror = (e) => {
                reject(e)
            }
        })
        const handler = (id, handler) => handlers[id] = handler

        const send = (data) => _socket.send(data)

        const disconnect = () => _socket.close()

        return {
            connect,
            disconnect,
            send,
            handler,
        }
    })();

    const webrtc = (() => {
        let pc
        let _signal

        const connect = async (signal) => {
            await signal.connect()
            // !to add error handler
            _signal = signal
            pc = new RTCPeerConnection({iceServers: [{urls: 'stun:stun.l.google.com:19302'}]})

            pc.oniceconnectionstatechange = () => {
                gui.log(`state â†’ ${pc.iceConnectionState}`, false, 'ICE')
            }

            let dc = pc.createDataChannel('data')
            dc.onmessage = event => {
                // let el = document.createElement('p')
                // el.appendChild(document.createTextNode(event.data))
                // document.getElementById('inboundDataChannelMessages').prepend(el);
                gui.log(`data chan: ${event.data}`, false, 'RTC')
            }

            pc.onicecandidate = e => {
                if (e.candidate) {
                    gui.log(`local ${e.candidate.candidate}`, false, 'ICE')
                    if (e.candidate.candidate === "") {
                    } else {
                        signal.send({t: "ICE", p: e.candidate})
                    }
                } else {
                    gui.log(`gather done`, false, 'ICE')
                }
            }

            signal.wire((message) => {
                switch (message.t) {
                    case "ANSWER":
                        pc.setRemoteDescription(message.p)
                        gui.log(`SDP answer: ${message.p.sdp}`, true, 'RTC')
                        return
                    case "ICE":
                        pc.addIceCandidate(message.p)
                        gui.log(`remote ${message.p.candidate}`, true, 'ICE')
                        return
                    case "LOG":
                        gui.log(message.p.text, true, message.p.tag)
                        return
                }
            })

            pc.createOffer().then(offer => {
                pc.setLocalDescription(offer)
                signal.send({t: "OFFER", p: offer});
                gui.log(`SDP offer: ${offer.sdp}`, false, 'RTC')
            })
        }
        const disconnect = () => {
            if (!pc) return

            pc.close()
            _signal.disconnect()
        }
        return {
            connect,
            disconnect,
        }
    })();


    const signal = (() => {
        const SIGNAL = 'x'
        return ({transport = {send: () => ({}), handler: () => ({})}}) => ({
            wire: (handler) => {
                transport.handler(SIGNAL, handler)
            },
            send: (dat) => transport.send(JSON.stringify(dat)),
            connect: async () => transport.connect(),
            disconnect: () => transport.disconnect()
        })
    })();

    (() => {
        const startEl = document.getElementById('controls__start');
        const stopEl = document.getElementById('controls__stop');
        startEl.addEventListener('click', () => {
            webrtc.connect(signal({transport: socket}));
        })
        stopEl.addEventListener('click', () => {
            webrtc.disconnect()
            gui.log('Termination', false, 'RTC')
            gui.log()
        })
    })()
</script>
</html>
